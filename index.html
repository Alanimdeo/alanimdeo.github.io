<!DOCTYPE html>
<html>
    <head>
        <title>피파 온라인 4 수수료 계산기</title>
        <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
        <link rel=" shortcut icon" href="res/logo.jfif">
        <link rel="icon" href="res/logo.jfif">
    </head>
    <script>
        let recognized = false;

        document.onload = function() {
            if (window.location.hostname != 'files.alan.imdeo.kr') {
                var menu = document.getElementById('menu_page');
                menu.innerHTML = '원본 페이지';
                menu.href = 'https://files.alan.imdeo.kr/fo4-taxcalculator';
            }
        }

        document.onpaste = function(event){
            var items = (event.clipboardData || event.originalEvent.clipboardData).items;
            console.log(JSON.stringify(items)); // will give you the mime types
            for (index in items) {
                var item = items[index];
                if (item.kind === 'file') {
                    var blob = item.getAsFile();
                    var reader = new FileReader();
                    reader.readAsDataURL(blob);
                    var urlCreator = window.URL || window.webkitURL;
                    var imageUrl = urlCreator.createObjectURL(blob);
                    var img = document.getElementById("image");
                    img.src = imageUrl;
                    document.getElementById('recognizeButton').disabled = false;
                    document.getElementById('imageloaded').innerHTML = '사진: 로딩됨!';
                }
            }
        }

        function recognize() {
            if (recognized) { location.href = '/'; }
            recognized = true;
            document.getElementById('recognizeButton').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 분석 중...';
            document.getElementById('recognizeButton').disabled = true;
            const { createWorker } = Tesseract;
            var img = document.getElementById('image');
            const worker = createWorker();
            const rectangles = [
                {
                    left: Math.floor(img.clientWidth * 0.6975),
                    top: Math.floor(img.clientHeight * 0.779),
                    width: Math.floor(img.clientWidth / 3.7615),
                    height: Math.floor(img.clientHeight / 15.6),
                },
                {
                    left: Math.floor(img.clientWidth * 0.3334),
                    top: Math.floor(img.clientHeight * 0.1659),
                    width: Math.floor(img.clientWidth / 12),
                    height: Math.floor(img.clientHeight / 1.82),
                },
            ];
            console.log('크기 값 설정:')
            console.log(rectangles);
            (async () => {
                await worker.load();
                await worker.loadLanguage('kor');
                await worker.initialize('kor');
                await worker.setParameters({
                    tessedit_char_whitelist: '0123456789',
                });
                let values = [];
                for (let i = 0; i < rectangles.length; i++) {
                    const { data: { text } } = await worker.recognize(img.src, { rectangle: rectangles[i] });
                    values.push(text);
                }
                values = { total: values[0].replace('\n', ''), players: values[1] };
                console.log('OCR 결과:');
                console.log(values);
                await worker.terminate();
                let players = values.players.split('\n');
                players.pop();
                players.push('0', '0', '0', '0');
                let tbody = '';
                let total = 0;
                if (document.getElementById('pcroom').checked) {
                    console.log('PC방 체크됨');
                    total = Math.floor(Number(values.total) * 20 / 17);
                } else {
                    total = Number(values.total);
                }
                for (let i = 0; i < players.length; i++) {
                    let add = Math.floor(Number(players[i]) * 0.12);
                    if (document.getElementById('pcroom').checked) {
                        add *= 2;
                    }
                    if (document.getElementById('topclass').checked) {
                        add += Math.floor(Number(players[i]) * 0.08);
                    }
                    if (players[i] != "0") {
                        if (i < 5) {
                            tbody += `<tr><th scope="row">${i + 1}</th><td>${players[i].replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",")} BP</td><td>${String(Number(players[i]) * 0.4).replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",")} BP</td><td>${String(add).replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",")} BP</td><td></td></tr>`;
                        } else {
                            if (document.getElementById('pcroom').checked) {
                                add = Math.floor(Number(players[i]) * 0.12);
                            } else { add = 0; }
                            if (document.getElementById('topclass').checked) {
                                add += Math.floor(Number(players[i]) * 0.08)
                            }
                            tbody += `<tr><th scope="row">${i + 1}</th><td>${players[i].replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",")} BP</td><td>${String(Number(players[i]) * 0.4).replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",")} BP</td><td>${String(add).replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",")} BP</td><td></td></tr>`;
                        }
                    }
                }
                console.log(`개별 선수 상위 7명: ${players}`);
                let pt = document.getElementById('playertable');
                pt.innerHTML = pt.innerHTML.replace('<tbody>', `<tbody>${tbody}`);
                document.getElementById('recognizeButton').innerHTML = '새로고침';
                document.getElementById('recognizeButton').disabled = false;
                document.getElementById('recognizeButtonTooltip').innerHTML = '한 번 사용하신 후에는 반드시 새로고침해야 합니다.';
                document.getElementById('table-total').innerHTML = `합계: ${String(total).replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",")} BP`;
                document.getElementById('table-top5').innerHTML = `상위 선수 5명 30% 적용: ${String(total + ((Number(players[0]) + Number(players[1]) + Number(players[2]) + Number(players[3]) + Number(players[4])) * 0.12)).replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",")} BP`;
            })();
        }

        function changeImageStatus() {
            if (document.getElementById('imageCheck').checked) { document.getElementById('image').style='visibility: visible;' } else { document.getElementById('image').style='visibility: hidden;' }
        }
    </script>
    <body>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
        <div class="container">
            <header class="d-flex flex-wrap justify-content-center py-3 mb-4 border-bottom">
                <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
                    <img src="res/logo.jfif" width="32" height="32">
                    <span class="fs-4">&nbsp;피파4 수수료 계산기</span>
                </a>
                <ul class="nav nav-pills">
                <li class="nav-item"><a href="https://alan.imdeo.kr" class="nav-link">홈</a></li>
                <li class="nav-item"><a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#howToModal">사용 방법</a></li>
                <li class="nav-item"><a id="menu_page" href="https://alanimdeo.github.io/fo4-taxcalculator" class="nav-link">백업 페이지</a></li>
                </ul>
            </header>
        </div>
        <div class="modal fade" id="howToModal" tabindex="-1" aria-labelledby="howToModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="howToModalLabel">사용 방법</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>이적시장에서 <img src="res/collecAll.png" height=30>를 누른 후 가운데 나오는 흰색 창을 캡쳐해서 붙여넣기 하세요.</p>
                    <p><b>반드시!</b> 피파 창 전체가 아닌 내부의 창을 캡쳐하셔야 합니다.</p>
                    <p>예시:</p>
                    <img src="res/capture.png" width=100%>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">확인</button>
                </div>
              </div>
            </div>
          </div>
        <div class="container">
            <h1>피파 온라인 4 수수료 계산기</h1>
            <p>TOP 클래스가 적용되어 있을 경우 TOP 클래스가 적용된 가격으로 계산됩니다.</p>
            <h5><b id="imageloaded">사진:</b></h5>
            <div class="mb-3">
                <label for="pcroom" class="form-label">혜택</label>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="topclass" checked>
                    <label class="form-check-label align-top" for="topclass">TOP 클래스</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="pcroom">
                    <label class="form-check-label align-top" for="pcroom">PC방 혜택 적용</label>
                </div>
            </div>
            <div class="row g-3">
                <div class="col-auto">
                    <button type="button" id="recognizeButton" class="btn btn-primary" onclick="recognize()" disabled>분석</button>
                </div>
                <div class="col-auto">
                    <p id="recognizeButtonTooltip"></p>
                </div>
            </div>
            <br>
            <table id="playertable" class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">선수 가격</th>
                        <th scope="col">수수료</th>
                        <th scope="col">차감액</th>
                        <th scope="col">합계</th>
                    </tr>
                </thead>
                <tbody></tbody>
                <caption>선수 계산에는 오류가 있을 수 있습니다. 단, 합계는 정상적으로 출력됩니다.</caption>
            </table>
            <b id="table-total">합계:</b><br>
            <b id="table-top5">상위 선수 5명 30% 적용:</b><br>
            <br>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="imageCheck" onclick="changeImageStatus()">
                <label class="form-check-label align-top" for="pcroom">이미지 보기</label>
            </div>
            <img id="image" style="visibility: hidden;">
        </div>
    </body>
</html>